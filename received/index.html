 <!DOCTYPE html>
<html style='background:#dadada;'>
<head>
<title>Poppy Show Me</title>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,height=device-height,initial-scale=1.0,maximum-scale=1.0, viewport-fit=cover'>

<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<style>
	body 		 { background: #dadada; font-family: 'Lucida Sans', Helvetica, Arial, 'Lucida Grande', sans-serif; font-weight: 400; font-size: 24px; line-height: 18px; padding: 0; margin: 0; text-align: center;}
	@media only screen and (max-width: 700px) { .wrap { padding: 15px; } }
	h1 		 { text-align: center; margin: 40px 0; font-size: 22px; font-weight: bold; color: #666; }
	.hover_red:hover { background:#948282; color:white}
	.btn 		 { border:1px solid black; padding:3px 9px; font-weight:bold; font-family:Lucida Sans; font-size:24px;}
</style>
</head>
<body>
<br><br><b>POPPY SHOW-ME</b> - DEMO ONLY - NOT FOR REAL USE<br><br>
<div id='send_link' style='background:darkgray; margin:1em'>
<br>Send the <span class='hover_red btn' id='link_btn'>link</span> to the caller&nbsp;&nbsp;<span id="linking" style="display:none">&nbsp;<i class="fa fa-spin fa-spinner"></i></span><br><br>
<b>GSM</b>: <input style='font-size:24px;padding-left:.5em;width:200px' placeholder='eg: 32123456789' type='number' id='to' /> &nbsp; <span class='hover_red btn' id='send_btn'>SEND</span><span id="sending" style="visibility:hidden">&nbsp;<i class="fa fa-spin fa-spinner"></i></span><span id="sent" style="visibility:hidden">&nbsp;<i class="fa fa-check"></i></span>
<br><br>
</div>
<h1>Images received<br><br></h1>

<div id='live'></div> 
<div id='photos'></div>

<center style='font-size:12px'>info@my-poppy.eu & GitHub project contributors - <a href='https://github.com/ccloquet/showme'>github.com/ccloquet/showme</a> - MIT Licence</center>
</body>
</html>

<script	src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.9/peer.min.js"></script>
<script src='params.js?a=2'></script>
<script>
	var url 	= new URL(document.URL);
	var userid 	= url.searchParams.get("userid");
	 			 
	var key, old_html;

	// WEBRTC, using PEER.JS  -----------------------------------------------------------------------
	var peers      = []	// => supports many incoming streams
	var peerids    = []

	function hasGetUserMedia() 
	{
		return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
	}
	//https://github.com/peers/peerjs/issues/227
	// pass the peer instance, and it will start sending heartbeats

	// stop them later
	// heartbeater.stop();

	function makePeerHeartbeater ( peer ) {
	    var timeoutId = 0;
	    function heartbeat () {
        	timeoutId = setTimeout( heartbeat, 10000 );
	        if ( peer.socket._wsOpen() ) {
        	    peer.socket.send( {type:'HEARTBEAT'} );
	        }
	    }
	    // Start 
	    heartbeat();
	    // return
	    return {
	        start : function () {
	            if ( timeoutId === 0 ) { heartbeat(); }
	        },
	        stop : function () {
	            clearTimeout( timeoutId );
	            timeoutId = 0;
	        }
	    };
	}
	// END WEBTRTC ----------------------------------------------------------------------------------

	function get_key(callback)		// generate the key &the STUN/TURN servers at sending time
	{					// => the link changes for each recipient -> allows a unique recipient id for the live streaming
		$.post(
		'query.php', 
		{
			action:	'init',
			userid:	userid					 
		},						
		function(e)					
		{
			if (e.key == '') 
			{
				return false;
			}
			else
			{
				if (!validate_key(e.key))			return false;

				key 	    = e.key

				callback(base_url, key)
				
				// WEBRTC, using PEER.JS  -----------------------------------------------------------------------

				if (!hasGetUserMedia()) return false;

				var ice_servers = e.ice_servers				 
				var mypeerid    = key + '-0'	// full key => verification possible before answering the call

				$('#live').append('<video width="320" height="240" id="video-'+mypeerid+'" autoplay></video>')

				peerids.push(mypeerid)
				peers.push(new Peer(mypeerid, {config: {iceServers: ice_servers}, host: peerjs_url, debug: 3, port: 443, secure: true}));

				makePeerHeartbeater( peers[peers.length-1] );
				peers[peers.length-1].on('error', function(err) { console.log('ERROR', this, err, peers); 	});
				peers[peers.length-1].on('open',  function(id)  { console.log('My peer ID is: ' + id);		});

				peers[peers.length-1].on('call', function(call) 
				{
					console.log(call)	// call.id,
					// from the call, get the remoteid (= call.peer)
					// verify it (! it should take less than 5 seconds !)
					// if verified => answer

					verify_key(call.peer.substr(0, call.peer.length-2), function()
					{
						console.log('REMOTE KEY IS ALLOWED');

						call.answer();	// no mediastream here -> one way only
						call.on('stream', function(remote_media_stream) 
						{
							var video 	= document.getElementById('video-'+mypeerid); 
							video.srcObject = remote_media_stream;
						});
					})
				});
				// END WEBTRTC ----------------------------------------------------------------------------------
			}
		}, 
		'json') 
	}

	// function: verify the key (deduced from the remote peer id) before answering
	function verify_key(received_key, callback)
	{
		$.post(
		'query.php', 
		{
			action:	'verify_key',
			userid:	userid,
			key:	received_key
		},						
		function(e)					
		{
			if (e.result == 'OK')
			{
				callback()
			}
		},
		'json')
	}

	function validate_key(key)
	{
		if (key.length > 512)			return false
		if (! /^[a-z0-9_/]+$/i.test(key))	return false

		return true
	}
	function sending_show()
	{
		$('#sent').css('visibility', 'hidden')
		$('#sending').css('visibility', '')
	}

	function sending_hide()
	{
		$('#sending').css('visibility', 'hidden')
		$('#sent').css('visibility', '')
	}

	function get_link()
	{
		$('#linking').fadeIn()
		get_key(
		function(base_url, key)
		{
			$('#linking').fadeOut()
			window.prompt('Copy the link to use it elsewhere (eg: email)', base_url + "?key=" + key)
		});
	}
	function send_sms()
	{
		get_key(
		function(base_url, key)
		{
			sending_show();

			$.post(
			'send_sms.php', 
			{
				key:	key, 
				to:	$('#to').val(),
				userid:	userid			
			},
			function()
			{
				$('#to').val('')
				sending_hide()
			});
	 		
			// add error management...
		});
	}

	function load_data()
	{
		$.post(
		'query.php', 
		{
			action:	'get_images',
			userid:	userid
		},
		function(e)				 
		{
			var html = ''
			for(var i=0; i<e.length; ++i)
			{
				var ts 	 = new Date(parseInt(e[i].dt*1000)).toLocaleString() 
			 	var src  = e[i].src					

				html += "<div style='font-size:18px; margin-bottom:1em'>" + ts + "</div>";

				// security measures :
				// the key should be valid (a-z0-9_) => not possible to insert code through this mechanism
				// only allowed extensions are possible

				if (!validate_key(src.substr(0, src.length-4))) 	continue;

				switch (src.substr(src.length-4))
				{
					case '.jpg':		html += "<img style='width:600px' src='"+src+"'/><br><br>";					break;
					case '.mp4':		html += "<video width='600' controls><source src='"+src+"' type='video/mp4'></video><br><br>";	break;
					default:		html += 'invalid file<br>'; 									continue;
				}
			}
			if (html != old_html)
			{
				$('#photos').html(html)		
			}
			old_html = html
		},
		'json') 
	}

	load_data()									// this is independent of the key 
	setInterval(load_data, 10000)							// would best be events, not polling ... Eg. using PubNub	

	$('#send_btn').on('click', send_sms)
	$('#link_btn').on('click', get_link)
	
</script>
